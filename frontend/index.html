<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>E2E Demo Frontend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 720px; margin: 40px auto; line-height: 1.5; }
    .row { display:flex; align-items:center; gap:10px; }
    .spinner {
      width: 16px; height: 16px; border: 2px solid #ccc; border-top-color: #333;
      border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display:none; }
    .ok { color: #1a7f37; font-weight: 600; }
    .err { color: #b91c1c; font-weight: 600; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    button { padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; background: #f8f8f8; }
    button:hover { background: #f0f0f0; }
  </style>
</head>
<body>
  <h1>End-to-End DevOps Demo</h1>

  <!-- Health status -->
  <div class="row" aria-live="polite" style="margin-bottom:16px;">
    <span id="spinner" class="spinner" aria-hidden="true"></span>
    <span>Status: <span id="status">Checking backendâ€¦</span></span>
  </div>

  <!-- Metrics: click-only -->
  <div style="margin-top:24px;">
    <button id="btnMetrics" type="button">Fetch metrics</button>
    <div id="metricsResult" class="mono" style="margin-top:10px;"></div>
  </div>

  <script>
    // --- Health check: shows spinner ~5s (backend delay), then OK/ERROR ---
    fetch('/api/health')
      .then(r => r.text())
      .then(text => {
        document.getElementById('spinner').classList.add('hidden');
        const s = document.getElementById('status');
        s.textContent = text.trim();
        s.classList.add('ok');
      })
      .catch(() => {
        document.getElementById('spinner').classList.add('hidden');
        const s = document.getElementById('status');
        s.textContent = 'ERROR';
        s.classList.add('err');
      });

    // --- Click-only metrics fetch ---
    async function fetchMetrics() {
      const out = document.getElementById('metricsResult');
      out.textContent = 'Loading...';
      try {
        const resp = await fetch('/api/metrics');
        const text = await resp.text();

        // Extract "app_requests_total <number>" from Prometheus exposition text.
        const m = text.match(/^\s*app_requests_total\s+(\d+)\s*$/m);
        if (m) {
          out.textContent = `app_requests_total = ${m[1]}`;
        } else {
          // If format changes, just show raw payload for visibility.
          out.textContent = text.trim();
        }
      } catch (e) {
        out.textContent = 'ERROR fetching metrics';
      }
    }

    document.getElementById('btnMetrics').addEventListener('click', fetchMetrics);
  </script>
</body>
</html>
