name: Switch Blue/Green with Auto-Rollback

on:
  workflow_dispatch:
    inputs:
      color:
        description: "Which color should become active (serve port 8081)?"
        required: true
        type: choice
        options: [blue, green]
      tag_blue:
        description: "Image tag for BLUE (e.g., latest or sha-xxxxxxx)"
        required: true
        default: "latest"
      tag_green:
        description: "Image tag for GREEN (e.g., latest or sha-xxxxxxx)"
        required: true
        default: "latest"
      force_failure:
        description: "FOR DEMO: force health-check failure to show rollback"
        required: true
        type: choice
        options: [false, true]
        default: "false"

permissions:
  contents: read
  packages: write

jobs:
  switch:
    runs-on: self-hosted
    steps:
      # 1Ô∏è‚É£ Checkout repository
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ Compute environment variables based on chosen color
      - name: Set environment variables
        run: |
          if [ "${{ github.event.inputs.color }}" = "green" ]; then
            echo "OVERLAY=infra/bluegreen/green-active.yml" >> $GITHUB_ENV
            echo "ACTIVE=web-green" >> $GITHUB_ENV
            echo "INACTIVE=web-blue" >> $GITHUB_ENV
            echo "PREVIOUS_COLOR=blue" >> $GITHUB_ENV
          else
            echo "OVERLAY=infra/bluegreen/blue-active.yml" >> $GITHUB_ENV
            echo "ACTIVE=web-blue" >> $GITHUB_ENV
            echo "INACTIVE=web-green" >> $GITHUB_ENV
            echo "PREVIOUS_COLOR=green" >> $GITHUB_ENV
          fi

          echo "TAG_BLUE=${{ github.event.inputs.tag_blue }}"   >> $GITHUB_ENV
          echo "TAG_GREEN=${{ github.event.inputs.tag_green }}" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Build & update the inactive color
      - name: Deploy inactive color
        run: |
          echo "üß± Deploying inactive color: ${INACTIVE}"
          docker compose \
            -f infra/compose.base.yml \
            -f infra/docker-compose.prod.yml \
            -f infra/bluegreen/docker-compose.bluegreen.yml \
            up -d --build "${INACTIVE}"

      # 4Ô∏è‚É£ Health check inactive color internally before switch
      - name: Health check inactive color
        run: |
          echo "üîç Checking ${INACTIVE} health before switching traffic"
          for i in {1..10}; do
            if docker compose \
              -f infra/compose.base.yml \
              -f infra/docker-compose.prod.yml \
              -f infra/bluegreen/docker-compose.bluegreen.yml \
              exec "${INACTIVE}" \
              curl -fsS http://localhost/api/health | grep -qi "ok"; then
              echo "‚úÖ ${INACTIVE} is healthy (pre-switch)"
              exit 0
            fi
            echo "Waiting for ${INACTIVE} to become ready... ($i/10)"
            sleep 5
          done
          echo "‚ùå ${INACTIVE} failed health check before switch"
          exit 1

      # üîå Free port 8081 before applying new overlay
      - name: Free port 8081 (stop old web containers)
        if: success()
        run: |
          echo "üîå Freeing port 8081 before switching overlay..."
          IDS=$(docker ps --filter "publish=8081" --format "{{.ID}}")
          if [ -n "$IDS" ]; then
            echo "Found containers using 8081: $IDS"
            docker stop $IDS || true
            docker rm $IDS || true
          else
            echo "No containers currently using port 8081."
          fi

      # 5Ô∏è‚É£ Switch overlay (make new color live)
      - name: Switch overlay to new color
        if: success()
        run: |
          echo "üö¶ Switching overlay to ${ACTIVE}..."
          docker compose \
            -f infra/compose.base.yml \
            -f infra/docker-compose.prod.yml \
            -f infra/bluegreen/docker-compose.bluegreen.yml \
            -f "${OVERLAY}" \
            up -d --force-recreate web-blue web-green

      # 6Ô∏è‚É£ Verify new color live on port 8081 (with demo force-failure)
      - name: Verify new color live on 8081
        id: verify
        continue-on-error: true
        run: |
          # DEMO FLAG: force failure to trigger rollback
          if [ "${{ github.event.inputs.force_failure }}" = "true" ]; then
            echo "‚ùå DEMO: Forcing health check failure so we can show automatic rollback"
            exit 1
          fi

          echo "üåê Verifying new live color on http://localhost:8081/api/health"
          for i in {1..6}; do
            if curl -fsS http://localhost:8081/api/health | grep -qi "ok"; then
              echo "‚úÖ New color healthy on 8081"
              exit 0
            fi
            echo "Waiting for new color to respond... ($i/6)"
            sleep 5
          done
          echo "‚ùå New color failed health check on 8081"
          exit 1

      # 7Ô∏è‚É£ Rollback automatically if health failed
      - name: Rollback to previous color
        if: steps.verify.outcome == 'failure'
        run: |
          echo "üîÅ Rolling back to ${PREVIOUS_COLOR}"
          docker compose \
            -f infra/compose.base.yml \
            -f infra/docker-compose.prod.yml \
            -f infra/bluegreen/docker-compose.bluegreen.yml \
            -f infra/bluegreen/${PREVIOUS_COLOR}-active.yml \
            up -d --force-recreate web-blue web-green

          echo "ü©∫ Checking rollback health..."
          for i in {1..6}; do
            if curl -fsS http://localhost:8081/api/health | grep -qi "ok"; then
              echo "‚úÖ Rollback successful ‚Äî previous color restored"
              exit 0
            fi
            echo "Waiting for rollback service... ($i/6)"
            sleep 5
          done
          echo "‚ùå Rollback service failed"
          exit 1
