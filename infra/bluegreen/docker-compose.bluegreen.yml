# Blue/Green overlay used together with:
#   - infra/compose.base.yml  (db, prometheus, grafana, etc.)
#   - infra/docker-compose.prod.yml (prod-style web image, no bind mounts)
#
# This file:
#  - disables the singleton 'web' and 'backend' services
#  - creates BLUE and GREEN copies for web + backend
#  - ensures each color resides in its own isolated network
#  - ensures BOTH backends use alias "backend" so that NGINX
#    can always proxy to http://backend:3000 regardless of color
#  - Prometheus scrapes BOTH backends in blue/green mode

services:
  # =======================
  # PROMETHEUS
  # =======================
  prometheus:
    image: prom/prometheus:v2.55.1
    container_name: prometheus
    command: ["--config.file=/etc/prometheus/prometheus.yml"]
    volumes:
      - ./prometheus/prometheus.bluegreen.yml:/etc/prometheus/prometheus.yml:ro
      - prom_data:/prometheus
    ports:
      - "9090:9090"
    depends_on:
      backend-blue:
        condition: service_started
      backend-green:
        condition: service_started
    networks:
      - default
      - net-blue
      - net-green
    restart: unless-stopped

  # Disable singleton backend/web containers from base/prod
  backend:
    profiles: ["_disabled"]
  web:
    profiles: ["_disabled"]

  # =======================
  # BLUE
  # =======================
  backend-blue:
    container_name: backend-blue
    image: ghcr.io/adrian-mihai-marghidan/end-to-end-devops-demo/backend:${TAG_BLUE:-latest}
    environment:
      DB_HOST: db
      DB_PORT: "5432"
      DB_USER: appuser
      DB_PASSWORD: apppass
      DB_NAME: appdb
      NODE_ENV: production
    depends_on:
      db:
        condition: service_started
    expose:
      - "3000"
    networks:
      net-blue:
        aliases:
          - backend    # NGINX will always use http://backend:3000
      default:
    restart: unless-stopped

  web-blue:
    container_name: web-blue
    image: ghcr.io/adrian-mihai-marghidan/end-to-end-devops-demo/web:${TAG_BLUE:-latest}
    depends_on:
      backend-blue:
        condition: service_started
    networks:
      - net-blue
      - default
    # port 8081 is added by blue-active.yml / green-active.yml
    restart: unless-stopped

  # =======================
  # GREEN
  # =======================
  backend-green:
    container_name: backend-green
    image: ghcr.io/adrian-mihai-marghidan/end-to-end-devops-demo/backend:${TAG_GREEN:-latest}
    environment:
      DB_HOST: db
      DB_PORT: "5432"
      DB_USER: appuser
      DB_PASSWORD: apppass
      DB_NAME: appdb
      NODE_ENV: production
    depends_on:
      db:
        condition: service_started
    expose:
      - "3000"
    networks:
      net-green:
        aliases:
          - backend    # same alias for green side
      default:
    restart: unless-stopped

  web-green:
    container_name: web-green
    image: ghcr.io/adrian-mihai-marghidan/end-to-end-devops-demo/web:${TAG_GREEN:-latest}
    depends_on:
      backend-green:
        condition: service_started
    networks:
      - net-green
      - default
    restart: unless-stopped

networks:
  net-blue:
  net-green:
  # default network comes from base compose
